---
import CardOption from "@/components/CardOption.astro";
import Cards from "@/components/Cards.astro";
import ClassesList from "@/components/classes/ClassesList.astro";
import ClassPage from "@/components/classes/ClassPage.astro";
import { SettingsView } from "@/components/settings/SettingsView";
import "@/styles/global.css";

const classes = ["scout", "soldier", "pyro", "demoman", "heavyweapons", "engineer", "medic", "sniper", "spy"];
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="preload" href="/img/logo-tc2.png" as="image" />
    <style>
      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      @keyframes modalFadeOut {
        from {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
        to {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.95);
        }
      }

      @keyframes overlayFadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes overlayFadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      .main-menu-bg {
        background: rgb(0 0 0 / 10%);
      }
      .scroll {
        scrollbar-color: #b4b4b4 transparent;
      }
      #menu-logo {
        filter: hue-rotate(222deg)
          drop-shadow(0 0 0.75rem rgba(182, 127, 72, 0.5));
      }
      .menu-option {
        /* transition color, background and scale */
        transition:
          color 0.2s ease-in-out,
          background 0.15s ease-in-out,
          transform 0.15s ease-in-out;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        color: #b4b4b4;
        transform: scale(1);
        transform-origin: left;
        display: inline-block;
      }
      .menu-hidden {
        display: none;
      }
      .menu-option:hover {
        color: rgb(255 153 51);
        /* gradient */
        background: linear-gradient(
          90deg,
          rgba(255, 153, 51, 0.2) 0%,
          rgba(255, 153, 51, 0.1) 100%
        );
        transform: scale(1.1);
      }
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        display: none; /* hidden by default */
        z-index: 10;
        transform: translate(-50%, -50%);
        animation: modalFadeIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        background: rgba(0, 0, 0, 0.9);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      }
      .modal.closing {
        animation: modalFadeOut 0.3s ease-in forwards;
      }
      .card-modal {
        padding: 2rem;
        border-radius: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 153, 51, 0.2);
      }

      #modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none; /* hidden by default */
        z-index: 5;
        animation: overlayFadeIn 0.4s ease-in forwards;
        transition: none;
      }

      #modal-overlay.closing {
        animation: overlayFadeOut 0.3s ease-in forwards;
      }

      .page {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #292526;
        z-index: 10;
      }

      .page-footer {
        height: auto;
        width: 100%;
        background: rgba(0, 0, 0, 0.5);
        padding: 1rem 10rem;
      }

      .page-footer-btn {
        color: #b4b4b4;
        cursor: pointer;
        transition: color 0.1s ease-in-out;
        background: #292526;
        border: 1px solid #b4b4b4;
        border-radius: 0.375rem;
        padding: 0.5rem 1rem;
      }

      .page-footer-btn:hover {
        background: linear-gradient(
          90deg,
          rgba(255, 153, 51, 0.2) 0%,
          rgba(255, 153, 51, 0.1) 100%
        );
        border: 1px solid rgb(255 153 51);
        color: rgb(255 153 51);
      }
    </style>
  </head>
  <body class="main-menu-bg">
    <div id="modal-overlay"></div>
    <div
      id="menu"
      class="flex flex-col items-start justify-center h-screen pl-60"
    >
      <img src="/img/logo-tc2.png" id="menu-logo" class="w-128" />
      <h2 class="text-6xl menu-option inline-block" data-menu="play">Play</h2>
      <br />
      <h2 class="text-4xl menu-option inline-block" data-menu="classes">
        Classes
      </h2>
      <br />
      <h2 class="text-4xl menu-option inline-block" data-menu="loadout">
        Loadout
      </h2>
      <br />
      <h2 class="text-4xl menu-option inline-block" data-menu="settings">
        Settings
      </h2>
      <br />
      <h2 class="text-4xl menu-option menu-hidden" data-menu="quit">Quit</h2>
      <h2 class="text-4xl menu-option menu-hidden" data-menu="disconnect">
        Disconnect
      </h2>
    </div>
    <div class="card-modal modal" data-modal="play">
      <Cards id="play-cards">
        <CardOption
          id="quickplay"
          name="Quickplay"
          desc="Join the best game we can find."
        />
        <CardOption
          id="explore"
          name="Explore"
          desc="Choose your favorites to play."
        />
        <CardOption id="host" name="Host" desc="Create your own game." />
        <!--<CardOption id="community" name="Community" desc="Look for a group to play with." />-->
        <!--<CardOption id="workshop" name="Workshop" desc="Play custom maps and modes." /> -->
        <CardOption id="training" name="Training" desc="Learn the ins and outs of TF2." />
      </Cards>
    </div>
    <div class="modal" data-modal="settings">
      <SettingsView client:only="react" />
    </div>
    
    {
      classes.map((cls) => (
        <div class="page" data-page={`class-${cls}`}>
          <div class="flex flex-col items-start justify-between h-full">
            <div class="flex-1">
              <ClassPage className={cls} />
            </div>
            <div class="page-footer">
              <button
                class="page-footer-btn page-back-btn text-4xl tf2-bold"
              >
                &larr; BACK
              </button>
            </div>
          </div>
        </div>
      ))
    }
    <div class="page" data-page="classes">
      <div class="flex flex-col items-start justify-between h-full">
        <div class="flex-1">
          <ClassesList />
        </div>
        <div class="page-footer">
          <button
            class="page-footer-btn page-back-btn text-4xl tf2-bold"
          >
            &larr; BACK
          </button>
        </div>
    </div>
    <script>
      import { playSound } from "@/util/playSound";
      import { listenRemote, runRpc } from "@/util/ws";

      const handlers = {
        play: () => {
          // cards modal
          toggleModal("play");
        },
        classes: () => {
          openPage("classes");
        },
        loadout: () => {
          runRpc("cmd", "open_charinfo");
        },
        settings: () => {
          toggleModal("settings");
        },
        quit: () => {
          runRpc("mmcmd", "quit");
        },
        disconnect: () => {
          runRpc("mmcmd", "disconnect");
        },
      };

      // add click event listeners to menu options
      const menuOptions = document.querySelectorAll(".menu-option");
      menuOptions.forEach((option) => {
        option.addEventListener("click", () => {
          const menu = option.dataset.menu;
          if (handlers[menu]) {
            handlers[menu]();
          }
        });

        option.addEventListener("mouseenter", () => {
          playSound("ui/buttonrollover.wav");
        });

        option.addEventListener("click", () => {
          playSound("ui/buttonclickrelease.wav");
        });

        option.addEventListener("pointerdown", () => {
          playSound("ui/buttonclick.wav");
        });
      });

      function toggleModal(modalName) {
        const modal = document.querySelector(`[data-modal='${modalName}']`);
        const overlay = document.getElementById("modal-overlay");

        if (modal.style.display === "none" || modal.style.display === "") {
          modal.style.display = "block";
          overlay.style.display = "block";
          // Trigger animation
          requestAnimationFrame(() => {
            modal.classList.remove("closing");
            overlay.classList.remove("closing");
          });
        } else {
          modal.classList.add("closing");
          overlay.classList.add("closing");
          setTimeout(() => {
            modal.style.display = "none";
            overlay.style.display = "none";
          }, 300);
          if (modalName === "settings") {
            runRpc("cmd", "mat_savechanges");
            runRpc("cmd", "host_writeconfig");
          }
        }
      }

      let pageStack: string[] = [];

      function openPage(pageName) {
        const activePage =
          pageStack.length > 0
            ? pageStack[pageStack.length - 1]
            : null;
        if (activePage) {
          const page = document.querySelector(`[data-page='${activePage}']`);
          page.style.display = "none";
        }
        const page = document.querySelector(`[data-page='${pageName}']`);
        page.style.display = "block";
        pageStack.push(pageName);
      }

      function closeActivePage() {
        if (pageStack.length > 0) {
          const activePage = pageStack[pageStack.length - 1];
          const page = document.querySelector(`[data-page='${activePage}']`);
          page.style.display = "none";
          pageStack.pop();
          if (pageStack.length > 0) {
            const previousPage = pageStack[pageStack.length - 1];
            const prevPageElem = document.querySelector(
              `[data-page='${previousPage}']`,
            );
            prevPageElem.style.display = "block";
          }
        }
      }

      document
        .querySelectorAll(".page-back-btn")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            closeActivePage();
          });
        });

      document.querySelectorAll(".class-card").forEach((card) => {
        card.addEventListener("click", () => {
          const className = card.dataset.class;
          openPage(`class-${className}`);
        });
      });

      document.querySelectorAll(".class-video-link").forEach((link) => {
        link.addEventListener("click", () => {
          runRpc("openurl", link.dataset.video);
        });
      });

      document.querySelectorAll(".class-loadout-link").forEach((link) => {
        link.addEventListener("click", () => {
          runRpc("cmd", `open_charinfo_direct ${link.dataset.classIndex}`);
        });
      });

      document.getElementById("modal-overlay").addEventListener("click", () => {
        // close all modals
        const modals = document.querySelectorAll(".modal");
        const overlay = document.getElementById("modal-overlay");

        modals.forEach((modal) => {
          modal.classList.add("closing");
        });
        overlay.classList.add("closing");

        setTimeout(() => {
          modals.forEach((modal) => {
            modal.style.display = "none";
          });
          overlay.style.display = "none";
        }, 300);
      });

      function setMenuState(state: string) {
        const quitOption = document.querySelector("[data-menu='quit']");
        const disconnectOption = document.querySelector(
          "[data-menu='disconnect']",
        );
        if (state === "connected") {
          quitOption.classList.add("menu-hidden");
          disconnectOption.classList.remove("menu-hidden");
          document.body.classList.add("main-menu-bg");
        } else {
          quitOption.classList.remove("menu-hidden");
          disconnectOption.classList.add("menu-hidden");
          document.body.classList.remove("main-menu-bg");
        }
      }

      document.getElementById("quickplay").addEventListener("click", () => {
        runRpc("mmcmd", "find_game");
        toggleModal("play");
      });

      document.getElementById("explore").addEventListener("click", () => {
        runRpc("mmcmd", "play_community");
        toggleModal("play");
      });

      document.getElementById("host").addEventListener("click", () => {
        runRpc("mmcmd", "create_server");
        toggleModal("play");
      });

      document.getElementById("training").addEventListener("click", () => {
        runRpc("mmcmd", "play_training");
        toggleModal("play");
      });

      listenRemote("ingame", (data) => {
        setMenuState(data === "1" ? "connected" : "disconnected");
      });
      runRpc("getingame").then((data) => {
        setMenuState(data === "1" ? "connected" : "disconnected");
      });
    </script>
  </body>
</html>
